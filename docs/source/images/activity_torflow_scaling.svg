<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1850px" preserveAspectRatio="none" style="width:3144px;height:1850px;" version="1.1" viewBox="0 0 3144 1850" width="3144px" zoomAndPan="magnify"><defs><filter height="300%" id="f9dswc3p3ycf8" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="292" x="1425.2188" y="26.708">"Torflow measurements scaling."</text><path d="M2421.5,35.3711 L2421.5,43.9375 L2401.5,47.9375 L2421.5,51.9375 L2421.5,60.5039 A0,0 0 0 0 2421.5,60.5039 L2782.5,60.5039 A0,0 0 0 0 2782.5,60.5039 L2782.5,45.3711 L2772.5,35.3711 L2421.5,35.3711 A0,0 0 0 0 2421.5,35.3711 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2772.5,35.3711 L2772.5,45.3711 L2782.5,45.3711 L2772.5,35.3711 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="2427.5" y="52.438">initialize measurements from previous Bandwidth File</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="165" x="2236.5" y="30.9531"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="145" x="2246.5" y="52.0918">prev_votes = VoteSet()</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="2262" y="84.9219"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="94" x="2272" y="106.0605">tot_net_bw = 0</text><path d="M2351,143.3086 L2351,151.875 L2331,155.875 L2351,159.875 L2351,168.4414 A0,0 0 0 0 2351,168.4414 L2523,168.4414 A0,0 0 0 0 2523,168.4414 L2523,153.3086 L2513,143.3086 L2351,143.3086 A0,0 0 0 0 2351,143.3086 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2513,143.3086 L2513,153.3086 L2523,153.3086 L2513,143.3086 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="2357" y="160.3755">for every measurement</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="2307" y="138.8906"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="2321" y="160.0293"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="337" x="2150.5" y="236.8594"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="317" x="2160.5" y="257.998">n.fbw_ratio = n.filt_bw/true_filt_avg[n.node_class()]</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="366" x="2136" y="290.8281"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="346" x="2146" y="311.9668">n.sbw_ratio = n.strm_bw/true_strm_avg[n.node_class()]</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="161" x="2238.5" y="344.7969"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="141" x="2248.5" y="365.9355">n.use_bw = n.desc_bw</text><path d="M2398,388.7656 L2398,450.2969 L2378,454.2969 L2398,458.2969 L2398,519.8281 A0,0 0 0 0 2398,519.8281 L2792,519.8281 A0,0 0 0 0 2792,519.8281 L2792,398.7656 L2782,388.7656 L2398,388.7656 A0,0 0 0 0 2398,388.7656 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2782,388.7656 L2782,398.7656 L2792,398.7656 L2782,388.7656 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="2404" y="405.8325">if n.sbw_ratio &gt; n.fbw_ratio:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="2404" y="420.9653">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="2420" y="420.9653">assert cs_junk.use_best_ratio == True</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="2404" y="436.0981">n.pid_error = (n.strm_bw - true_strm_avg[n.node_class()])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="2484" y="451.231">/ true_strm_avg[n.node_class()]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="2404" y="466.3638">else:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="2404" y="481.4966">n.pid_error = (n.filt_bw - true_filt_avg[n.node_class()])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="2484" y="496.6294">/ true_filt_avg[n.node_class()]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="2404" y="511.7622">0 &lt;= n.pid_error &lt;= 500.0</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="2260" y="437.3125"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="98" x="2270" y="458.4512">n.pid_error = ...</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2226,539.8281,2412,539.8281,2424,551.8281,2412,563.8281,2226,563.8281,2214,551.8281,2226,539.8281" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="186" x="2226" y="555.6362">n.idhex in prev_votes.vote_map?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="2194" y="549.2339">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="2424" y="549.2339">no</text><path d="M1725.125,573.8281 L1725.125,589.9609 L1705.125,593.9609 L1725.125,597.9609 L1725.125,614.0938 A0,0 0 0 0 1725.125,614.0938 L2033.125,614.0938 A0,0 0 0 0 2033.125,614.0938 L2033.125,583.8281 L2023.125,573.8281 L1725.125,573.8281 A0,0 0 0 0 1725.125,573.8281 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2023.125,573.8281 L2023.125,583.8281 L2033.125,583.8281 L2023.125,573.8281 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1731.125" y="590.895">if n.measured_at &gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="1731.125" y="606.0278">prev_votes.vote_map[n.idhex].measured_at;</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="1681.125" y="576.9766"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1695.125" y="598.1152"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="1630.625,649.0938,1755.625,649.0938,1767.625,661.0938,1755.625,673.0938,1630.625,673.0938,1618.625,661.0938,1630.625,649.0938" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="125" x="1630.625" y="664.9019">measurement newer?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="1598.625" y="658.4995">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="1767.625" y="658.4995">no</text><path d="M1100.25,683.0938 L1100.25,706.793 L1080.25,710.793 L1100.25,714.793 L1100.25,738.4922 A0,0 0 0 0 1100.25,738.4922 L1440.25,738.4922 A0,0 0 0 0 1440.25,738.4922 L1440.25,693.0938 L1430.25,683.0938 L1100.25,683.0938 A0,0 0 0 0 1100.25,683.0938 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1430.25,683.0938 L1430.25,693.0938 L1440.25,693.0938 L1430.25,683.0938 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="1106.25" y="700.1606">if n.idhex in prev_consensus</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="1122.25" y="715.2935">and ("Guard" in prev_consensus[n.idhex].flags</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="1122.25" y="730.4263">and "Exit" not in prev_consensus[n.idhex].flags)</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="1056.25" y="693.8086"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1070.25" y="714.9473"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="1010.75,773.4922,1125.75,773.4922,1137.75,792.6992,1125.75,811.9063,1010.75,811.9063,998.75,792.6992,1010.75,773.4922" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="111" x="1010.75" y="783.7026">in prev_consensus,</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="47" x="1010.75" y="796.5073">is guard</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="70" x="1010.75" y="809.312">but not exit?</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="978.75" y="790.105">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="1137.75" y="790.105">no</text><path d="M509,821.9063 L509,853.1719 L489,857.1719 L509,861.1719 L509,892.4375 A0,0 0 0 0 509,892.4375 L956,892.4375 A0,0 0 0 0 956,892.4375 L956,831.9063 L946,821.9063 L509,821.9063 A0,0 0 0 0 509,821.9063 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M946,821.9063 L946,831.9063 L956,831.9063 L946,821.9063 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="515" y="838.9731">if n.idhex not in prev_votes.vote_map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="410" x="531" y="854.106">or n.measured_at - prev_votes.vote_map[n.idhex].measured_at</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="547" y="869.2388">&gt; cs_junk.guard_sample_rate:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="547" y="884.3716"># cs_jung.guard_sample_rate = 2*7*24*60*60 # 2wks</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="465" y="840.1875"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="479" y="861.3262"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="408,927.4375,546,927.4375,558,939.4375,546,951.4375,408,951.4375,396,939.4375,408,927.4375" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="138" x="408" y="943.2456">diff bigger than 2 weeks</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="376" y="936.8433">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="558" y="936.8433">no</text><path d="M200,961.4375 L200,1022.9688 L180,1026.9688 L200,1030.9688 L200,1092.5 A0,0 0 0 0 200,1092.5 L587,1092.5 A0,0 0 0 0 587,1092.5 L587,971.4375 L577,961.4375 L200,961.4375 A0,0 0 0 0 200,961.4375 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M577,961.4375 L577,971.4375 L587,971.4375 L577,961.4375 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="206" y="978.5044">1.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="222" y="978.5044">full feedback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="206" y="993.6372">n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="270" y="1008.77">cs_junk.K_p,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="270" y="1023.9028">cs_junk.K_i,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="270" y="1039.0356">cs_junk.K_d,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="270" y="1054.1685">cs_junk.K_i_decay)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="222" y="1069.3013">= n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="282" y="1084.4341">1.0, 0, 0, 0)</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="156" y="1009.9844"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="170" y="1031.123"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="103.8125" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="38" y="1127.5"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="228" x="48" y="1148.6387">self.prev_error = prev_vote.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="158" x="48" y="1162.6074">self.pid_bw = self.use_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="182" x="64" y="1176.5762">+ self.use_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="203" x="64" y="1190.5449"># + self.desc_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="240" x="48" y="1204.5137">self.pid_error_sum = 0 + self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="146" x="48" y="1218.4824">n.new_bw = self.pid_bw</text><path d="M818,961.4375 L818,1015.4023 L798,1019.4023 L818,1023.4023 L818,1077.3672 A0,0 0 0 0 818,1077.3672 L1205,1077.3672 A0,0 0 0 0 1205,1077.3672 L1205,971.4375 L1195,961.4375 L818,961.4375 A0,0 0 0 0 818,961.4375 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1195,961.4375 L1195,971.4375 L1205,971.4375 L1195,961.4375 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="824" y="978.5044">\# Use new measurement but not feedback</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="824" y="993.6372">n.copy_vote(prev_vote.vote_map[n.idhex]));</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="824" y="1008.77">n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="872" y="1023.9028">cs_junk.K_p,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="73" x="872" y="1039.0356">cs_junk.K_i,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="872" y="1054.1685">cs_junk.K_d,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="872" y="1069.3013">0.0, False)</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="774" y="1002.418"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="788" y="1023.5566"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="145.7188" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="358" x="607" y="1112.3672"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="204" x="617" y="1133.5059">\# self.new_bw = vote.bw * 1000</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="159" x="617" y="1147.4746">self.pid_bw = vote.pid_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="251" x="617" y="1161.4434">self.pid_error_sum = vote.pid_error_sum</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="189" x="617" y="1175.4121">self.pid_delta = vote.pid_delta</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="621" y="1189.3809"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="338" x="617" y="1203.3496">n.new_bw = self.use_bw + self.use_bw * self_pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="621" y="1217.3184"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="258" x="617" y="1231.2871">n.measured_at = prev_vote.measured_at</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="206" x="617" y="1245.2559">n.pid_error = prev_vote.pid_error</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="477,1264.0859,489,1276.0859,477,1288.0859,465,1276.0859,477,1264.0859" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="1602,821.9063,1717,821.9063,1729,834.7109,1717,847.5156,1602,847.5156,1590,834.7109,1602,821.9063" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="111" x="1602" y="832.1167">in prev_consensus,</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="96" x="1602" y="844.9214">is guard and exit</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="1570" y="832.1167">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="14" x="1729" y="832.1167">no</text><path d="M1407,857.5156 L1407,919.0469 L1387,923.0469 L1407,927.0469 L1407,988.5781 A0,0 0 0 0 1407,988.5781 L1794,988.5781 A0,0 0 0 0 1794,988.5781 L1794,867.5156 L1784,857.5156 L1407,857.5156 A0,0 0 0 0 1407,857.5156 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1784,857.5156 L1784,867.5156 L1794,867.5156 L1784,857.5156 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="1413" y="874.5825">n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1445" y="889.7153">cs_junk.K_p*weight,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="1445" y="904.8481">cs_junk.K_i*weight,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1445" y="919.981">cs_junk.K_d*weight,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1445" y="935.1138">cs_junk.K_i_decay)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="1413" y="950.2466">n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1461" y="965.3794">1.0*1.0, 0, 0, 0)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1413" y="980.5122">\# so, same code as for when diff is bigger than 2 weeks</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="1363" y="906.0625"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1377" y="927.2012"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="103.8125" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="1245" y="1023.5781"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="228" x="1255" y="1044.7168">self.prev_error = prev_vote.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="158" x="1255" y="1058.6855">self.pid_bw = self.use_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="182" x="1271" y="1072.6543">+ self.use_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="203" x="1271" y="1086.623"># + self.desc_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="240" x="1255" y="1100.5918">self.pid_error_sum = 0 + self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="146" x="1255" y="1114.5605">n.new_bw = self.pid_bw</text><path d="M1976,861.9336 L1976,870.5 L1956,874.5 L1976,878.5 L1976,887.0664 A0,0 0 0 0 1976,887.0664 L2126,887.0664 A0,0 0 0 0 2126,887.0664 L2126,871.9336 L2116,861.9336 L1976,861.9336 A0,0 0 0 0 1976,861.9336 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2116,861.9336 L2116,871.9336 L2126,871.9336 L2116,861.9336 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="1982" y="879.0005">\#again, same code</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="1932" y="857.5156"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="1946" y="878.6543"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="103.8125" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="260" x="1814" y="926.4844"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="228" x="1824" y="947.623">self.prev_error = prev_vote.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="158" x="1824" y="961.5918">self.pid_bw = self.use_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="182" x="1840" y="975.5605">+ self.use_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="203" x="1840" y="989.5293"># + self.desc_bw * self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="240" x="1824" y="1003.498">self.pid_error_sum = 0 + self.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="146" x="1824" y="1017.4668">n.new_bw = self.pid_bw</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="1659.5,1133.3906,1671.5,1145.3906,1659.5,1157.3906,1647.5,1145.3906,1659.5,1133.3906" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="1068.25,1294.0859,1080.25,1306.0859,1068.25,1318.0859,1056.25,1306.0859,1068.25,1294.0859" style="stroke: #A80036; stroke-width: 1.5;"/><path d="M2347.4375,683.0938 L2347.4375,714.3594 L2327.4375,718.3594 L2347.4375,722.3594 L2347.4375,753.625 A0,0 0 0 0 2347.4375,753.625 L2760.4375,753.625 A0,0 0 0 0 2760.4375,753.625 L2760.4375,693.0938 L2750.4375,683.0938 L2347.4375,683.0938 A0,0 0 0 0 2347.4375,683.0938 " fill="#FBFB77" filter="url(#f9dswc3p3ycf8)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M2750.4375,683.0938 L2750.4375,693.0938 L2760.4375,693.0938 L2750.4375,683.0938 " fill="#FBFB77" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="2353.4375" y="700.1606">\# Reset values. Don't vote/sample this measurement round.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="2353.4375" y="715.2935">\# is in the previous bwfile, but haven't check the consensus</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="2353.4375" y="730.4263">n.revert_to_vote(prev_votes.vote_map[n.idhex])</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="2353.4375" y="745.5591">\# which calls again self.copy_vote(vote)</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="24" x="2303.4375" y="701.375"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="2317.4375" y="722.5137"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="117.7813" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="304" x="2163.4375" y="788.625"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="211" x="2173.4375" y="809.7637">self.new_bw = prev_vote.bw*1000</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="192" x="2173.4375" y="823.7324">self.pid_bw = prev_vote.pid_bw</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="284" x="2173.4375" y="837.7012">self.pid_error_sum = prev_vote.pid_error_sum</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="222" x="2173.4375" y="851.6699">self.pid_delta = prev_vote.pid_delta</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="0" x="2177.4375" y="865.6387"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="187" x="2173.4375" y="879.6074">self.pid_error = vote.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="239" x="2173.4375" y="893.5762">self.measured_at = vote.measured_at</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="1693.125,1324.0859,1705.125,1336.0859,1693.125,1348.0859,1681.125,1336.0859,1693.125,1324.0859" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="61.9063" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="314" x="2790.4375" y="573.8281"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="294" x="2800.4375" y="594.9668">n.new_bw = n.use_bw + n.use_bw * n.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="186" x="2800.4375" y="608.9355">n.pid_error_sum = n.pid_error</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="132" x="2800.4375" y="622.9043">n.pid_bw = n.new_bw</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2319,1354.0859,2331,1366.0859,2319,1378.0859,2307,1366.0859,2319,1354.0859" style="stroke: #A80036; stroke-width: 1.5;"/><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="289" x="2174.5" y="1494.8906"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="269" x="2184.5" y="1516.0293">prev_consensus[n.idhex].measured = True</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="176" x="2231" y="1563.8594"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="156" x="2241" y="1584.998">tot_net_bw += n.new_bw</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2192.5,1446.4883,2445.5,1446.4883,2457.5,1458.4883,2445.5,1470.4883,2192.5,1470.4883,2180.5,1458.4883,2192.5,1446.4883" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="2323" y="1480.6987">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="253" x="2192.5" y="1462.2964">prev_consensus[n.idhex].bandwidth != None</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2319,1617.8281,2331,1629.8281,2319,1641.8281,2307,1629.8281,2319,1617.8281" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2243,1398.0859,2395,1398.0859,2407,1410.0859,2395,1422.0859,2243,1422.0859,2231,1410.0859,2243,1398.0859" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="2323" y="1432.2964">yes</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="152" x="2243" y="1413.894">n.idhex in prev_consensus</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2319,1661.8281,2331,1673.8281,2319,1685.8281,2307,1673.8281,2319,1661.8281" style="stroke: #A80036; stroke-width: 1.5;"/><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2242,192.8594,2396,192.8594,2408,204.8594,2396,216.8594,2242,216.8594,2230,204.8594,2242,192.8594" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="2242" y="208.6675">for n in nodes.itervalues()?</text><rect fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" height="33.9688" rx="12.5" ry="12.5" style="stroke: #A80036; stroke-width: 1.5;" width="55" x="2291.5" y="1771.8281"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="35" x="2301.5" y="1792.9668">cap...</text><polygon fill="#FEFECE" filter="url(#f9dswc3p3ycf8)" points="2242,1727.8281,2396,1727.8281,2408,1739.8281,2396,1751.8281,2242,1751.8281,2230,1739.8281,2242,1727.8281" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="154" x="2242" y="1743.6362">for n in nodes.itervalues()?</text><ellipse cx="2220" cy="1781.8281" fill="none" filter="url(#f9dswc3p3ycf8)" rx="10" ry="10" style="stroke: #000000; stroke-width: 1.0;"/><ellipse cx="2220.5" cy="1782.3281" fill="#000000" filter="url(#f9dswc3p3ycf8)" rx="6" ry="6" style="stroke: none; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="64.9219" y2="84.9219"/><polygon fill="#A80036" points="2315,74.9219,2319,84.9219,2323,74.9219,2319,78.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="118.8906" y2="138.8906"/><polygon fill="#A80036" points="2315,128.8906,2319,138.8906,2323,128.8906,2319,132.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="270.8281" y2="290.8281"/><polygon fill="#A80036" points="2315,280.8281,2319,290.8281,2323,280.8281,2319,284.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="324.7969" y2="344.7969"/><polygon fill="#A80036" points="2315,334.7969,2319,344.7969,2323,334.7969,2319,338.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="378.7656" y2="437.3125"/><polygon fill="#A80036" points="2315,427.3125,2319,437.3125,2323,427.3125,2319,431.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="168" x2="168" y1="1043.9531" y2="1127.5"/><polygon fill="#A80036" points="164,1117.5,168,1127.5,172,1117.5,168,1121.5" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="786" y1="1036.3867" y2="1112.3672"/><polygon fill="#A80036" points="782,1102.3672,786,1112.3672,790,1102.3672,786,1106.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="396" x2="168" y1="939.4375" y2="939.4375"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="168" x2="168" y1="939.4375" y2="1009.9844"/><polygon fill="#A80036" points="164,999.9844,168,1009.9844,172,999.9844,168,1003.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="558" x2="786" y1="939.4375" y2="939.4375"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="786" y1="939.4375" y2="1002.418"/><polygon fill="#A80036" points="782,992.418,786,1002.418,790,992.418,786,996.418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="168" x2="168" y1="1231.3125" y2="1276.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="168" x2="465" y1="1276.0859" y2="1276.0859"/><polygon fill="#A80036" points="455,1272.0859,465,1276.0859,455,1280.0859,459,1276.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="786" y1="1258.0859" y2="1276.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="786" x2="489" y1="1276.0859" y2="1276.0859"/><polygon fill="#A80036" points="499,1272.0859,489,1276.0859,499,1280.0859,495,1276.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="477" x2="477" y1="874.1563" y2="927.4375"/><polygon fill="#A80036" points="473,917.4375,477,927.4375,481,917.4375,477,921.4375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1375" x2="1375" y1="940.0313" y2="1023.5781"/><polygon fill="#A80036" points="1371,1013.5781,1375,1023.5781,1379,1013.5781,1375,1017.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1944" x2="1944" y1="891.4844" y2="926.4844"/><polygon fill="#A80036" points="1940,916.4844,1944,926.4844,1948,916.4844,1944,920.4844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1590" x2="1375" y1="834.7109" y2="834.7109"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1375" x2="1375" y1="834.7109" y2="906.0625"/><polygon fill="#A80036" points="1371,896.0625,1375,906.0625,1379,896.0625,1375,900.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1729" x2="1944" y1="834.7109" y2="834.7109"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1944" x2="1944" y1="834.7109" y2="857.5156"/><polygon fill="#A80036" points="1940,847.5156,1944,857.5156,1948,847.5156,1944,851.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1375" x2="1375" y1="1127.3906" y2="1145.3906"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1375" x2="1647.5" y1="1145.3906" y2="1145.3906"/><polygon fill="#A80036" points="1637.5,1141.3906,1647.5,1145.3906,1637.5,1149.3906,1641.5,1145.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1944" x2="1944" y1="1030.2969" y2="1145.3906"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1944" x2="1671.5" y1="1145.3906" y2="1145.3906"/><polygon fill="#A80036" points="1681.5,1141.3906,1671.5,1145.3906,1681.5,1149.3906,1677.5,1145.3906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="998.75" x2="477" y1="792.6992" y2="792.6992"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="477" x2="477" y1="792.6992" y2="840.1875"/><polygon fill="#A80036" points="473,830.1875,477,840.1875,481,830.1875,477,834.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1137.75" x2="1659.5" y1="792.6992" y2="792.6992"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1659.5" x2="1659.5" y1="792.6992" y2="821.9063"/><polygon fill="#A80036" points="1655.5,811.9063,1659.5,821.9063,1663.5,811.9063,1659.5,815.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="477" x2="477" y1="1288.0859" y2="1306.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="477" x2="1056.25" y1="1306.0859" y2="1306.0859"/><polygon fill="#A80036" points="1046.25,1302.0859,1056.25,1306.0859,1046.25,1310.0859,1050.25,1306.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1659.5" x2="1659.5" y1="1157.3906" y2="1306.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1659.5" x2="1080.25" y1="1306.0859" y2="1306.0859"/><polygon fill="#A80036" points="1090.25,1302.0859,1080.25,1306.0859,1090.25,1310.0859,1086.25,1306.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.25" x2="1068.25" y1="727.7773" y2="773.4922"/><polygon fill="#A80036" points="1064.25,763.4922,1068.25,773.4922,1072.25,763.4922,1068.25,767.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2315.4375" x2="2315.4375" y1="735.3438" y2="788.625"/><polygon fill="#A80036" points="2311.4375,778.625,2315.4375,788.625,2319.4375,778.625,2315.4375,782.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1618.625" x2="1068.25" y1="661.0938" y2="661.0938"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.25" x2="1068.25" y1="661.0938" y2="693.8086"/><polygon fill="#A80036" points="1064.25,683.8086,1068.25,693.8086,1072.25,683.8086,1068.25,687.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1767.625" x2="2315.4375" y1="661.0938" y2="661.0938"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2315.4375" x2="2315.4375" y1="661.0938" y2="701.375"/><polygon fill="#A80036" points="2311.4375,691.375,2315.4375,701.375,2319.4375,691.375,2315.4375,695.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.25" x2="1068.25" y1="1318.0859" y2="1336.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1068.25" x2="1681.125" y1="1336.0859" y2="1336.0859"/><polygon fill="#A80036" points="1671.125,1332.0859,1681.125,1336.0859,1671.125,1340.0859,1675.125,1336.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2315.4375" x2="2315.4375" y1="906.4063" y2="1336.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2315.4375" x2="1705.125" y1="1336.0859" y2="1336.0859"/><polygon fill="#A80036" points="1715.125,1332.0859,1705.125,1336.0859,1715.125,1340.0859,1711.125,1336.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1693.125" x2="1693.125" y1="610.9453" y2="649.0938"/><polygon fill="#A80036" points="1689.125,639.0938,1693.125,649.0938,1697.125,639.0938,1693.125,643.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2214" x2="1693.125" y1="551.8281" y2="551.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1693.125" x2="1693.125" y1="551.8281" y2="576.9766"/><polygon fill="#A80036" points="1689.125,566.9766,1693.125,576.9766,1697.125,566.9766,1693.125,570.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2424" x2="2947.4375" y1="551.8281" y2="551.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2947.4375" x2="2947.4375" y1="551.8281" y2="573.8281"/><polygon fill="#A80036" points="2943.4375,563.8281,2947.4375,573.8281,2951.4375,563.8281,2947.4375,567.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1693.125" x2="1693.125" y1="1348.0859" y2="1366.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="1693.125" x2="2307" y1="1366.0859" y2="1366.0859"/><polygon fill="#A80036" points="2297,1362.0859,2307,1366.0859,2297,1370.0859,2301,1366.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2947.4375" x2="2947.4375" y1="635.7344" y2="1366.0859"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2947.4375" x2="2331" y1="1366.0859" y2="1366.0859"/><polygon fill="#A80036" points="2341,1362.0859,2331,1366.0859,2341,1370.0859,2337,1366.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="471.2813" y2="539.8281"/><polygon fill="#A80036" points="2315,529.8281,2319,539.8281,2323,529.8281,2319,533.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1528.8594" y2="1563.8594"/><polygon fill="#A80036" points="2315,1553.8594,2319,1563.8594,2323,1553.8594,2319,1557.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1470.4883" y2="1494.8906"/><polygon fill="#A80036" points="2315,1484.8906,2319,1494.8906,2323,1484.8906,2319,1488.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2457.5" x2="2473.5" y1="1458.4883" y2="1458.4883"/><polygon fill="#A80036" points="2469.5,1536.3594,2473.5,1546.3594,2477.5,1536.3594,2473.5,1540.3594" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2473.5" x2="2473.5" y1="1458.4883" y2="1629.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2473.5" x2="2331" y1="1629.8281" y2="1629.8281"/><polygon fill="#A80036" points="2341,1625.8281,2331,1629.8281,2341,1633.8281,2337,1629.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1597.8281" y2="1617.8281"/><polygon fill="#A80036" points="2315,1607.8281,2319,1617.8281,2323,1607.8281,2319,1611.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1422.0859" y2="1446.4883"/><polygon fill="#A80036" points="2315,1436.4883,2319,1446.4883,2323,1436.4883,2319,1440.4883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2407" x2="2495.5" y1="1410.0859" y2="1410.0859"/><polygon fill="#A80036" points="2491.5,1536.3594,2495.5,1546.3594,2499.5,1536.3594,2495.5,1540.3594" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2495.5" x2="2495.5" y1="1410.0859" y2="1673.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2495.5" x2="2331" y1="1673.8281" y2="1673.8281"/><polygon fill="#A80036" points="2341,1669.8281,2331,1673.8281,2341,1677.8281,2337,1673.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1641.8281" y2="1661.8281"/><polygon fill="#A80036" points="2315,1651.8281,2319,1661.8281,2323,1651.8281,2319,1655.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1378.0859" y2="1398.0859"/><polygon fill="#A80036" points="2315,1388.0859,2319,1398.0859,2323,1388.0859,2319,1392.0859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="216.8594" y2="236.8594"/><polygon fill="#A80036" points="2315,226.8594,2319,236.8594,2323,226.8594,2319,230.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1685.8281" y2="1695.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="3118.4375" y1="1695.8281" y2="1695.8281"/><polygon fill="#A80036" points="3114.4375,936.2461,3118.4375,926.2461,3122.4375,936.2461,3118.4375,932.2461" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="3118.4375" x2="3118.4375" y1="204.8594" y2="1695.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="3118.4375" x2="2408" y1="204.8594" y2="204.8594"/><polygon fill="#A80036" points="2418,200.8594,2408,204.8594,2418,208.8594,2414,204.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2230" x2="24" y1="204.8594" y2="204.8594"/><polygon fill="#A80036" points="20,922.2461,24,932.2461,28,922.2461,24,926.2461" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="24" x2="24" y1="204.8594" y2="1707.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="24" x2="2319" y1="1707.8281" y2="1707.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1707.8281" y2="1727.8281"/><polygon fill="#A80036" points="2315,1717.8281,2319,1727.8281,2323,1717.8281,2319,1721.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="172.8594" y2="192.8594"/><polygon fill="#A80036" points="2315,182.8594,2319,192.8594,2323,182.8594,2319,186.8594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1751.8281" y2="1771.8281"/><polygon fill="#A80036" points="2315,1761.8281,2319,1771.8281,2323,1761.8281,2319,1765.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2319" y1="1805.7969" y2="1815.7969"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2319" x2="2420" y1="1815.7969" y2="1815.7969"/><polygon fill="#A80036" points="2416,1786.8125,2420,1776.8125,2424,1786.8125,2420,1782.8125" style="stroke: #A80036; stroke-width: 1.5;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2420" x2="2420" y1="1739.8281" y2="1815.7969"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2420" x2="2408" y1="1739.8281" y2="1739.8281"/><polygon fill="#A80036" points="2418,1735.8281,2408,1739.8281,2418,1743.8281,2414,1739.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2230" x2="2220" y1="1739.8281" y2="1739.8281"/><line style="stroke: #A80036; stroke-width: 1.5;" x1="2220" x2="2220" y1="1739.8281" y2="1771.8281"/><polygon fill="#A80036" points="2216,1761.8281,2220,1771.8281,2224,1761.8281,2220,1765.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" textLength="119" x="1511.7188" y="1837.0791">last updated 2021-01-08</text><!--
@startuml
title "Torflow measurements scaling."

:prev_votes = VoteSet();
note right
initialize measurements from previous Bandwidth File
end note
:tot_net_bw = 0;
:;
note right
    for every measurement
end note
while (for n in nodes.itervalues()?)
    :n.fbw_ratio = n.filt_bw/true_filt_avg[n.node_class()];
    :n.sbw_ratio = n.strm_bw/true_strm_avg[n.node_class()];
    :n.use_bw = n.desc_bw;
    :n.pid_error = ...;
    note right
        if n.sbw_ratio > n.fbw_ratio:
        #assert cs_junk.use_best_ratio == True
        n.pid_error = (n.strm_bw - true_strm_avg[n.node_class()])
                            / true_strm_avg[n.node_class()]
        else:
        n.pid_error = (n.filt_bw - true_filt_avg[n.node_class()])
                            / true_filt_avg[n.node_class()]
        0 <= n.pid_error <= 500.0
    end note
    if (n.idhex in prev_votes.vote_map?) then (yes)
        :;
        note right
        if n.measured_at >
        prev_votes.vote_map[n.idhex].measured_at;
        end note
        if (measurement newer?) then (yes)
            :;
            note right
            if n.idhex in prev_consensus
                and ("Guard" in prev_consensus[n.idhex].flags
                and "Exit" not in prev_consensus[n.idhex].flags)
            end note
            if (in prev_consensus, \nis guard \nbut not exit?) then (yes)
                :;
                note right
                if n.idhex not in prev_votes.vote_map
                    or n.measured_at - prev_votes.vote_map[n.idhex].measured_at
                        > cs_junk.guard_sample_rate:
                        # cs_jung.guard_sample_rate = 2*7*24*60*60 # 2wks
                end note
                if (diff bigger than 2 weeks) then (yes)
                    :;
                    note right
                    # full feedback
                    n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                    cs_junk.K_p,
                                    cs_junk.K_i,
                                    cs_junk.K_d,
                                    cs_junk.K_i_decay)
                        = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                       1.0, 0, 0, 0)
                    end note
                    :self.prev_error = prev_vote.pid_error
                    self.pid_bw = self.use_bw
                        + self.use_bw * self.pid_error
                        # + self.desc_bw * self.pid_error
                    self.pid_error_sum = 0 + self.pid_error
                    n.new_bw = self.pid_bw;
                else (no)
                    :;
                    note right
                    \# Use new measurement but not feedback
                    n.copy_vote(prev_vote.vote_map[n.idhex]));
                    n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                cs_junk.K_p,
                                cs_junk.K_i,
                                cs_junk.K_d,
                                0.0, False)
                    end note
                    :\# self.new_bw = vote.bw * 1000
                    self.pid_bw = vote.pid_bw
                    self.pid_error_sum = vote.pid_error_sum
                    self.pid_delta = vote.pid_delta

                    n.new_bw = self.use_bw + self.use_bw * self_pid_error

                    n.measured_at = prev_vote.measured_at
                    n.pid_error = prev_vote.pid_error;
                endif
            else (no)
                if (in prev_consensus, \nis guard and exit) then (yes)
                    :;
                    note right
                    n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                            cs_junk.K_p*weight,
                            cs_junk.K_i*weight,
                            cs_junk.K_d*weight,
                            cs_junk.K_i_decay)
                    n.new_bw = n.get_pid_bw(prev_votes.vote_map[n.idhex],
                                1.0*1.0, 0, 0, 0)
                    \# so, same code as for when diff is bigger than 2 weeks
                    end note
                    :self.prev_error = prev_vote.pid_error
                    self.pid_bw = self.use_bw
                        + self.use_bw * self.pid_error
                        # + self.desc_bw * self.pid_error
                    self.pid_error_sum = 0 + self.pid_error
                    n.new_bw = self.pid_bw;
                else (no)
                    :;
                    note right
                    \#again, same code
                    end note
                    :self.prev_error = prev_vote.pid_error
                    self.pid_bw = self.use_bw
                        + self.use_bw * self.pid_error
                        # + self.desc_bw * self.pid_error
                    self.pid_error_sum = 0 + self.pid_error
                    n.new_bw = self.pid_bw;
                endif
            endif
        else (no)
            :;
            note right
            \# Reset values. Don't vote/sample this measurement round.
            \# is in the previous bwfile, but haven't check the consensus
            n.revert_to_vote(prev_votes.vote_map[n.idhex])
            \# which calls again self.copy_vote(vote)
            end note
            :self.new_bw = prev_vote.bw*1000
            self.pid_bw = prev_vote.pid_bw
            self.pid_error_sum = prev_vote.pid_error_sum
            self.pid_delta = prev_vote.pid_delta

            self.pid_error = vote.pid_error
            self.measured_at = vote.measured_at;

        endif
    else (no)
        :n.new_bw = n.use_bw + n.use_bw * n.pid_error
        n.pid_error_sum = n.pid_error
        n.pid_bw = n.new_bw;
    endif

    if (n.idhex in prev_consensus) then (yes)
        if (prev_consensus[n.idhex].bandwidth != None) then (yes)
            :prev_consensus[n.idhex].measured = True;
            :tot_net_bw += n.new_bw;
        endif
    endif
endwhile
while (for n in nodes.itervalues()?)
    :cap...;
endwhile
stop

footer last updated 2021-01-08
@enduml

PlantUML version 1.2018.13(Mon Nov 26 17:11:51 GMT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.9.1+1-post-Debian-1deb10u2
Operating System: Linux
OS Version: 4.19.0-13-amd64
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>